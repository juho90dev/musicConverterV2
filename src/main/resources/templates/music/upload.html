<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <th:block th:replace="~{common/header :: header-library}"></th:block>
    <title>Upload Music - Music Converter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
    /* 1. 전체 페이지 스크롤 방지 (musicList와 동일) */
    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden; 
        background-color: #ffffff;
    }
    
    /* 2. 헤더 높이만큼 여백 확보 */
    .content-body { padding-top: 80px; }

    /* 3. 중앙 업로드 영역 (고정하지 않고 스크롤 컨테이너 안에 배치) */
    #scroll-container {
        height: calc(100vh - 80px); /* 헤더 제외 전체 높이 */
        overflow-y: auto;
        padding-bottom: 50px;
    }

    .upload-card {
        border: 1px solid rgba(0,0,0,0.06) !important;
        border-radius: 24px;
        padding: 2.5rem;
        background: #fff;
        box-shadow: 0 10px 40px rgba(0,0,0,0.03);
        margin-top: 20px; /* 제목과의 간격 */
    }
    #uploadBtn {
	    background-color: #764ba2 !important; /* 보라색 고정 */
	    border: none !important;
	    color: white !important;
	    font-weight: bold;
	    height: 56px; /* 높이 고정으로 움직임 방지 */
	    transition: background-color 0.2s ease; /* 위치 이동 없이 색상만 부드럽게 */
	}
	/* 마우스 올렸을 때 (색상만 살짝 변경) */
#uploadBtn:hover {
    background-color: #5d3b8a !important; /* 조금 더 진한 보라색 */
    transform: none !important; /* ⚠️ 움직임 유발 요소 제거 */
}/* 드래그 영역 아이콘 색상 */
.bi-cloud-arrow-up, .text-primary {
    color: #764ba2 !important;
}

/* 프로그레스 바 색상 */
.progress-bar {
    background-color: #764ba2 !important;
}

/* 입력창 테두리 강조 */
.form-control:focus {
    border-color: #764ba2 !important;
    box-shadow: 0 0 0 0.2rem rgba(118, 75, 162, 0.25) !important;
}
	.text-primary { color: #764ba2 !important; }
    /* 드래그 영역 */
    .file-drop-area {
        border: 2px dashed #e0e0e0;
        border-radius: 16px;
        padding: 40px;
        background-color: #fcfcfc;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    /* 드래그 중일 때 보라색 테두리로 강조 */
    .file-drop-area.dragover {
        border-color: #764ba2;
        background-color: #f1f0ff;
    }

    /* 프로그레스 바 보라색 */
    .progress-bar {
        background-color: #764ba2 !important;
    }

    /* 입력창 포커스 시 보라색 테두리 */
    .form-control:focus {
        border-color: #764ba2;
        box-shadow: 0 0 0 0.25rem rgba(118, 75, 162, 0.15);
    }
</style>

<body>
<header th:replace="~{common/header :: menu}"></header>

<main class="container content-body">
    <div id="scroll-container">
        <div class="row justify-content-center mt-4">
            <div class="col-md-7 col-lg-6">
                
                <div class="text-center mb-4">
                    <p class="text-primary fw-bold mb-1" style="font-size: 0.9rem; letter-spacing: 1px;">DIRECT UPLOAD</p>
                    <h2 class="fw-bold" style="letter-spacing: -1px; color: #222;">음악 업로드</h2>
                    <p class="text-muted small">보유하고 계신 MP3 파일을 목록에 추가합니다.</p>
                </div>

                <div class="card upload-card">
                    <label class="form-label small fw-bold text-muted">가수</label>
                    <input type="text" id="artist" class="form-control mb-3" placeholder="가수 이름을 입력하세요">

                    <label class="form-label small fw-bold text-muted">곡 제목</label>
                    <input type="text" id="title" class="form-control mb-4" placeholder="제목을 입력하세요">

                    <label class="form-label small fw-bold text-muted">파일 선택</label>
                    <div class="file-drop-area text-center" id="drop-area">
                        <i class="bi bi-cloud-arrow-up text-primary" style="font-size: 2.5rem;"></i>
                        <p class="mb-0 mt-2" id="file-name" style="font-size: 0.9rem;">파일을 드래그하거나 클릭하세요</p>
                        <input type="file" id="fileInput" class="d-none" accept=".mp3">
                    </div>

                    <div id="progress-wrapper" style="display: none;" class="mt-4">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small text-muted">업로드 중...</span>
                            <span class="small fw-bold text-primary" id="progress-text">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 py-3 mt-4 fw-bold" id="uploadBtn" onclick="handleUpload()">
                        <i class="bi bi-check-circle me-2"></i> 업로드 완료
                    </button>
                </div>

            </div>
        </div>
    </div>
</main>


<script>
//common.js 호환용
function renderPage() {
    if (!localStorage.getItem('accessToken')) {
        location.href = "/";
    }
    // 헤더 유저 정보 업데이트하는 공통함수 호출
    if (typeof refreshHeaderUI === "function") refreshHeaderUI();
}


    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('file-name');

    // 클릭 이벤트(영역 클릭시 파일 탐색기 열기)
    dropArea.addEventListener('click', () => fileInput.click());

    // 파일 선택 후 실행
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
        	
        	// 파일 이름
            fileName.innerText = fileInput.files[0].name;
        	// css 
            fileName.classList.add('text-primary', 'fw-bold');
        }
    });

    // 드래그 앤 드롭 효과
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
        	// 브라우저가 파일을 직접 실행하는것 방지
            e.preventDefault();
            dropArea.classList.add('dragover');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
        }, false);
    });

    
    // 파일을 박스에 놓으면 input 태그에 해당 파일 할당
    dropArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        if (files.length > 0) {
            fileName.innerText = files[0].name;
            fileName.classList.add('text-primary', 'fw-bold');
        }
    });

// 업로드
async function handleUpload() {
	
	// 데이터 추출 및 공백 제거
	const artist = document.getElementById('artist').value.trim();
	const title = document.getElementById('title').value.trim();
	const file = fileInput.files[0];
	
	// 유효성 검사 (하나라도 없으면 중단)
	if (!artist || !title || !file) {
		Swal.fire('입력 확인', '가수, 제목, 파일을 모두 등록해주세요.', 'warning');
	return;
	}
	
	// 파일은 JSON으로 보낼 수 없으니 FormData 객체 사용
	const formData = new FormData();
	formData.append('artist', artist);
	formData.append('title', title);
	formData.append('file', file);
	
	
	const uploadBtn = document.getElementById('uploadBtn');
	const progressWrapper = document.getElementById('progress-wrapper');
	const progressBar = document.getElementById('progress-bar');
	const progressText = document.getElementById('progress-text');
	
	try {
		// 중복 클릭 방지
		uploadBtn.disabled = true;
		// 로딩바 표시
		progressWrapper.style.display = 'block';
		
		// 서버 통신 (fetch API)
		const response = await fetch('/api/music/upload', {
			method: 'POST',
			headers: {
				// Content-Type은 브라우저가 자동으로 세팅하게 비워둔다
				// 직접 설정하면 브라우저가 boundary 설정을 하지 않는다.
				'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
			},
			body: formData
		});
		
		// 결과 처리
		if (response.ok) {
			Swal.fire({
				icon: 'success',
				title: '업로드 완료',
				text: '음악이 성공적으로 등록되었습니다.',
				timer: 1500,
				showConfirmButton: false
			}).then(() => {
				// 리스트페이지로 이동
				location.href = "/music/musiclist";
			});
		} else {
			const error = await response.json();
			Swal.fire('업로드 실패', error.message || '파일 저장 중 오류가 발생했습니다.', 'error');
		}
	} catch (err) {
		console.error(err);
		Swal.fire('네트워크 오류', '서버와 연결할 수 없습니다.', 'error');
	} finally {
		// 버튼 다시 활성화
		uploadBtn.disabled = false;
	}
}

    
</script>
</body>
</html>