<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<th:block th:replace="~{common/header :: header-library}"></th:block>
	<title>My Page - Music Converter</title>
	<style>
        body {
        	background-color: #f8f9fa;
        }
        
        /* 헤더 높이만큼 여백 확보 */
        .content-body {
        	padding-top: 100px;
        }

        /* 카드 디자인 및 호버 효과 */
        .history-card {
            border: none;
            border-radius: 1.2rem;
            transition: all 0.3s ease;
        }
        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 5px 12px;
            border-radius: 20px;
        }
        
		/* 메인 테마색 */
        .text-primary {
        	color: #764ba2 !important;
        } 
        .btn-primary {
        	background-color: #764ba2;
        	border: none;
        }
        .btn-primary:hover {
        	background-color: #663d91;
        }
    </style>
</head>

<body>
<header th:replace="~{common/header :: menu}"></header>
<main class="container content-body">

<div class="row justify-content-center">
	<div class="col-md-10 text-center mt-5">
		<h2 class="fw-bold mb-2">My Music List</h2>
		<p class="text-muted mb-4">
			<span id="userNickname" class="fw-bold text-primary text-decoration-underline">사용자</span>님이 변환하신 음악 목록입니다.
		</p>
		<div class="card p-4 shadow-sm border-0 rounded-4 bg-white mb-5">
			<div class="input-group input-group-lg">
				<input type="text" id="searchInput" class="form-control border-light-subtle" placeholder="곡 제목으로 검색해보세요...">
				<button class="btn btn-primary px-4" type="button" onclick="searchMusic()">검색</button>
			</div>
		</div>
		<div class="row justify-content-center">
			<div class="col-md-12">
				<div id="music-list-container" class="row g-4"></div>
				<div id="sentinel" style="height: 50px;"></div>
				<div id="loading-spinner" class="py-4 d-none text-center">
					<div class="spinner-border text-primary" role="status"></div>
				</div>
			</div>
		</div>
	</div>
</div>
</main>


<script>
function refreshHeaderUI() {
    const token = localStorage.getItem('accessToken');
    const nickname = localStorage.getItem('nickname');
    const userMenu = document.getElementById('user-menu');
    const nicknameSpan = document.getElementById('user-nickname');
        
    if (token && userMenu) {
        userMenu.classList.remove('d-none');
        if (nicknameSpan) {
            nicknameSpan.innerText = decodeURIComponent(nickname) + "님";
        }
    } else if (userMenu) {
        userMenu.classList.add('d-none');
    }
}


let currentPage = 0;
let isLastPage = false;
let isLoading = false;




document.addEventListener("DOMContentLoaded", function() {
	// 1. 닉네임 설정
	const nickname = localStorage.getItem('nickname');
	if (nickname) {
		document.getElementById('userNickname').innerText = nickname;
	}
	
	// 2. 로그인 여부 체크
	const token = localStorage.getItem('accessToken');
	if (!token) {
		alert("로그인이 필요한 페이지입니다.");
		window.location.href = "/";
		return;
	}
	// 3. 무한 스크롤 관찰자 설정 (감시 시작)
    const observer = new IntersectionObserver((entries) => {
        // 바닥(sentinel)이 보이고 + 로딩 중이 아니고 + 마지막 페이지가 아닐 때만 다음 페이지 호출
        if (entries[0].isIntersecting && !isLoading && !isLastPage) {
            console.log("바닥 감지! 다음 페이지를 불러옵니다.");
            loadMyMusicList();
        }
    }, { threshold: 0.1 });
	
    const sentinel = document.getElementById('sentinel');
    if (sentinel) observer.observe(sentinel);
    
	console.log("UI 렌더링 완료. 서버 연결은 컨트롤러 생성 후 활성화 예정.");
	loadMyMusicList();
});


// 나중에 검색 기능 
function searchMusic() {
	const keyword = document.getElementById('searchInput').value;
	alert("검색 기능은 준비 중입니다: " + keyword);
}



function renderPage() {
	// 
	console.log("Mypage: renderPage skip (static UI)");
}



async function loadMyMusicList() {
    // 로딩 중이거나 마지막 페이지면 더 이상 요청하지 않음
    if (isLoading || isLastPage) return;
    
    isLoading = true;
    const spinner = document.getElementById('loading-spinner');
    if (spinner) spinner.classList.remove('d-none');

    try {
        console.log(`서버 요청: 페이지 ${currentPage}`);
        // 1. 페이지 번호와 사이즈를 쿼리 파라미터로 전달
        const response = await authFetch(`/api/list?page=${currentPage}&size=20`);
        
        if (response.ok) {
            const data = await response.json(); // Slice 또는 Page 객체 수신
            
            // 2. 서버 응답 데이터 구조에 따라 리스트 추출 (Slice 객체면 data.content)
            const list = data.content ? data.content : data;
            
            // 3. 데이터 그리기
            renderMusicCards(list);
            
            // 4. 마지막 페이지 여부 업데이트 (서버가 보내주는 last 필드 확인)
            isLastPage = data.last; 
            
            // 5. 다음 요청을 위해 페이지 번호 증가
            if (!isLastPage) {
                currentPage++;
            }
        } else {
            console.error("서버 응답 에러:", response.status);
        }
    } catch (err) {
        console.error("네트워크 오류:", err);
    } finally {
        isLoading = false;
        if (spinner) spinner.classList.add('d-none');
    }
}
        


function renderMusicCards(musicList) {
    const container = document.getElementById('music-list-container');
    
    // 첫 페이지이면서 데이터가 아예 없는 경우 처리
    if (currentPage === 0 && (!musicList || musicList.length === 0)) {
        container.innerHTML = `<div class="col-12 text-center py-5 text-muted">아직 변환된 음악이 없습니다.</div>`;
        return;
    }

    musicList.forEach(music => {
        const cardHtml = `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card history-card shadow-sm h-100 p-3">
                    <div class="d-flex align-items-center mb-3">
                        <img src="" 
                           class="rounded-3 me-3" style="width: 60px; height: 60px; object-fit: cover;">
                        <div class="text-start overflow-hidden">
                            <h6 class="mb-0 text-truncate">${music.title}</h6>
                            <small class="text-muted">${music.artist}</small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <span class="status-badge bg-light text-primary">${music.genre || 'Music'}</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="playMusic('${music.filePath}')">▶</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        // [중요] innerHTML = "" 대신 insertAdjacentHTML을 써야 기존 목록 뒤에 붙습니다.
        container.insertAdjacentHTML('beforeend', cardHtml);
    });
}





</script>
</body>
</html>