<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<th:block th:replace="~{common/header :: header-library}"></th:block>
	<title>My Page - Music Converter</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<style>
		/* 1. ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ (ì´ì¤‘ ìŠ¤í¬ë¡¤ ì œê±° í•µì‹¬) */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; 
            /* background-color: #f8f9fa; */
            background-color: #ffffff;;
        }
        
        /* í—¤ë” ë†’ì´ë§Œí¼ ì—¬ë°± í™•ë³´ */
        .content-body { padding-top: 80px; }

        /* ìŠ¬ë¦¼í•œ ì¹´ë“œ ë””ìì¸ (ëª¨ë°”ì¼ ìµœì í™”) */
        .history-card {
            border: 1px solid rgba(0,0,0,0.05) !important;
            border-radius: 12px;
            transition: all 0.2s ease;
            background: #fff;
            border-bottom: 0.5px solid #eee !important; /* ì•„ì£¼ ì–‡ì€ êµ¬ë¶„ì„  */
            transition: background 0.2s;
        }
        .history-card:hover {
			/*transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05) !important; */
            background-color: #f9f9f9 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 5px 12px;
            border-radius: 20px;
        }
        
		/* ë©”ì¸ í…Œë§ˆìƒ‰ */
        .text-primary {
        	color: #764ba2 !important;
        }
        
        .btn-primary {
        	background-color: #764ba2;
        	border: none;
        }
        .btn-primary:hover {
        	background-color: #663d91;
        }
        .sticky-top {
        	/* ë°°ê²½ìƒ‰ì„ í˜ì´ì§€ ë°°ê²½ê³¼ ë§ì¶”ê¸° */
        	background-color: #ffffff !important;
        	/* ê·¸ë¦¼ìë¡œ ìŠ¤í¬ë¡¤ ë  ë•Œ êµ¬ë¶„ê° */
        	box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        /* 3. ë°ì´í„° ìŠ¤í¬ë¡¤ ì˜ì—­ */
        #scroll-container {
            flex: 1;
            /* í—¤ë”(80) + ê³ ì •ì„¹ì…˜(ì•½ 95) */
            margin-top: 175px; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 30px;
        }
        #scroll-container::-webkit-scrollbar {
        	width: 5px;
        }
        #scroll-container::-webkit-scrollbar-thumb {
        	background: #ddd; border-radius: 10px;
        }
        
        /* ê¸°ì¡´ .history-card ìŠ¤íƒ€ì¼ì„ ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ êµì²´í•˜ê±°ë‚˜ ì¶”ê°€í•˜ì„¸ìš” */
        .history-card {
        	border: none !important;
        	border-radius: 0;
        	background: transparent;
        	transition: background 0.2s ease;
        	/* í•˜ë‹¨ êµ¬ë¶„ì„  */
        	border-bottom: 1px solid rgba(0,0,0,0.06) !important; 
        }
        
        .history-card:hover {
        	/* íŠ€ì–´ë‚˜ì˜¤ëŠ” íš¨ê³¼ ì œê±° */
        	transform: none !important;
        	/* ì‚´ì§ ëˆŒë¦¬ëŠ” ëŠë‚Œë§Œ ë¶€ì—¬ */
        	background-color: rgba(0,0,0,0.02);
        	box-shadow: none !important;
        }
        
        /* ì•¨ë²” ì•„íŠ¸ì—ë§Œ ì‚´ì§ ë‘¥ê·¼ íš¨ê³¼ */
        .album-art {
        	width: 52px;
        	height: 52px;
        	border-radius: 6px;
        	object-fit: cover;
        	flex-shrink: 0;
        }
        
        /* ì¬ìƒ/ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ë” ê¹”ë”í•˜ê²Œ */
        .action-btn {
        	/* ê¸°ë³¸ ê²€ì • ê³„ì—´ */
        	color: #333;
        	font-size: 1.1rem;
        	padding: 8px;
        	transition: opacity 0.2s;
        }
        
        .action-btn:active {
        	opacity: 0.5;
        }
        
        /* SweetAlert2 íŒì—… í¬ê¸° ë° í°íŠ¸ ë¯¸ì„¸ ì¡°ì • */
        .swal2-popup {
        	padding: 1rem !important;
        	border-radius: 15px !important;
        }
        .swal2-title {
        /* ì œëª© í¬ê¸° ì¶•ì†Œ */
		    font-size: 1.1rem !important; 
		}
		.swal2-html-container {
			/* ë³¸ë¬¸ í¬ê¸° ì¶•ì†Œ */
		    font-size: 0.9rem !important; 
		}
		.swal2-confirm, .swal2-cancel {
			/* ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
		    font-size: 0.85rem !important; 
		    padding: 8px 16px !important;
		}
    </style>
</head>

<body>
<header th:replace="~{common/header :: menu}"></header>
<main class="container content-body">

<div class="fixed-top-section bg-white" style="position: fixed; top: 90px; left: 0; right: 0; z-index: 1020;">
    <div class="container text-center pt-4">
        <h2 class="fw-bold mb-1" style="font-size: 1.5rem;">My Music List</h2>
        <p class="text-muted mb-2 small">
            <span id="userNickname" class="fw-bold text-primary">ì‚¬ìš©ì</span>ë‹˜ì˜ ìŒì•… ëª©ë¡
        </p>
        
        <div class="card border-0 bg-light-subtle rounded-4 mb-2">
            <div class="card-body p-2">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control border-0 bg-transparent" placeholder="ê³¡ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰...">
                    <button class="btn btn-primary rounded-3 px-3" type="button" onclick="searchMusic()">ê²€ìƒ‰</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="scroll-container" style="margin-top: 180px; height: calc(100vh - 180px); overflow-y: auto; padding-bottom: 80px;">
    <div class="container">
        <div id="music-list-container" class="row g-4">
            </div>
        
        <div id="sentinel" style="height: 50px;"></div>
        
        <div id="loading-spinner" class="py-4 d-none text-center">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    </div>
</div>
</main>


<script>

async function downloadMusic(filePath, title, artist) {
	// 1. ì‘ì€ ì•Œë¦¼ì°½ìœ¼ë¡œ ì‹œì‘ ì•Œë¦¼
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000
    });
    Toast.fire({ icon: 'info', title: 'ë‹¤ìš´ë¡œë“œë¥¼ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...' });

    try {
        // 2. ì»¨íŠ¸ë¡¤ëŸ¬(/api/fileDownload)ë¡œ JSON ë°ì´í„° ì „ì†¡
        const response = await authFetch('/api/fileDownload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                artist: artist,
                title: title,
                filePath: filePath
            })
        });

        if (!response.ok) throw new Error("ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ ì—†ê±°ë‚˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");

        /* // 3. ì„œë²„ì—ì„œ ë³´ë‚¸ ìŠ¤íŠ¸ë¦¼ì„ Blob(ë°”ì´ë„ˆë¦¬ ë°ì´í„°)ìœ¼ë¡œ ë°›ê¸°
        const blob = await response.blob();
        
        // 4. ë¸Œë¼ìš°ì €ì—ì„œ íŒŒì¼ì„ ì €ì¥í•˜ê¸° ìœ„í•œ ê°€ìƒ ë§í¬ ìƒì„±
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // íŒŒì¼ëª… ì„¤ì • (ê°€ìˆ˜-ì œëª©.mp3)
        a.download = `${artist}-${title}.mp3`;
        
        document.body.appendChild(a);
        a.click(); // ì‹¤ì œ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
        
        // 5. ë©”ëª¨ë¦¬ ì •ë¦¬ ë° ì œê±°
        window.URL.revokeObjectURL(url);
        a.remove(); */

    } catch (error) {
        console.error("Download Error:", error);
        Swal.fire({
            title: 'ì˜¤ë¥˜ ë°œìƒ',
            text: 'ë‹¤ìš´ë¡œë“œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
            icon: 'error',
            width: '300px'
        });
    }

    
}
/* 
async function downloadMusic(filePath, title, artist) {
    try {
        const response = await authFetch('/api/fileDownload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                artist: artist,
                title: title,
                filePath: filePath
            })
        });

        if (!response.ok) throw new Error("ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");

        // íŒŒì¼ ë°ì´í„°(Blob) ì²˜ë¦¬
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${artist}-${title}.mp3`;
        document.body.appendChild(a);
        a.click();
        
        window.URL.revokeObjectURL(url);
        a.remove();
        
    } catch (error) {
        console.error("ë‹¤ìš´ë¡œë“œ ì—ëŸ¬:", error);
        Swal.fire("ì˜¤ë¥˜", "ë‹¤ìš´ë¡œë“œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
    }
} */


//ì¬ìƒ ë²„íŠ¼ ê¸°ëŠ¥ (í† ìŠ¤íŠ¸ í˜•íƒœ ì•Œë¦¼)
function playMusic(filePath) {
    console.log("ì¬ìƒ ì‹œë„:", filePath);
    
    // ì¬ìƒì€ ê°€ë²¼ìš´ ì•ˆë‚´ê°€ ì¢‹ìœ¼ë¯€ë¡œ ìš°ì¸¡ ìƒë‹¨ í† ìŠ¤íŠ¸ ì•Œë¦¼ ì‚¬ìš©
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        width: '400px', // í† ìŠ¤íŠ¸ ë„ˆë¹„ë„ ì¡°ì ˆ ê°€ëŠ¥
        timerProgressBar: true
    });

    Toast.fire({
        icon: 'info',
        title: 'ì¬ìƒ ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'
    });
}

//ì‚­ì œ ë²„íŠ¼ ê¸°ëŠ¥ (í™•ì¸ ì°½ í˜•íƒœ ì•Œë¦¼)
async function deleteMusic(musicId, element) {
    // 1. í™•ì¸ ì°½ ë„ìš°ê¸°
    const result = await Swal.fire({
        title: 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        text: "ëª©ë¡ì—ì„œ ì´ ê³¡ì´ ì‚¬ë¼ì§€ë©°, ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
        icon: 'warning',
        width: '300px', // ë„ˆë¹„ ì¶•ì†Œ
        showCancelButton: true,
        confirmButtonColor: '#764ba2', // ì„œë¹„ìŠ¤ í…Œë§ˆìƒ‰
        cancelButtonColor: '#aaa',
        confirmButtonText: 'ì‚­ì œ',
        cancelButtonText: 'ì·¨ì†Œ',
        reverseButtons: true // í™•ì¸/ì·¨ì†Œ ë²„íŠ¼ ìœ„ì¹˜ ë°˜ì „ (ì·¨ì†Œê°€ ì™¼ìª½)
    });

    // 2. ì‚¬ìš©ìê°€ 'ì‚­ì œ'ë¥¼ ëˆŒë €ì„ ë•Œë§Œ ì‹¤í–‰
    if (result.isConfirmed) {
        console.log("ì‹¤ì œ ì„œë²„ ì‚­ì œ ìš”ì²­ ë³´ë‚¼ ID:", musicId);
        
        // ì¼ë‹¨ì€ ìš”ì²­ì´ ì„±ê³µí–ˆë‹¤ê³  ê°€ì •í•˜ê³  í™”ë©´ì—ì„œ ì œê±° (ë‚˜ì¤‘ì— fetchì™€ ì—°ë™)
        element.closest('.col-12').remove();

        // ì‚­ì œ ì™„ë£Œ ì•Œë¦¼
        Swal.fire({
            title: 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
            icon: 'success',
            width: '250px',
            timer: 1000,
            showConfirmButton: false
        });
    }
}








function refreshHeaderUI() {
    const token = localStorage.getItem('accessToken');
    const nickname = localStorage.getItem('nickname');
    const userMenu = document.getElementById('user-menu');
    const nicknameSpan = document.getElementById('user-nickname');
        
    if (token && userMenu) {
        userMenu.classList.remove('d-none');
        if (nicknameSpan) {
            nicknameSpan.innerText = decodeURIComponent(nickname) + "ë‹˜";
        }
    } else if (userMenu) {
        userMenu.classList.add('d-none');
    }
}


let currentPage = 0;
let isLastPage = false;
let isLoading = false;




document.addEventListener("DOMContentLoaded", function() {
	// 1. ë‹‰ë„¤ì„ ì„¤ì •
	const nickname = localStorage.getItem('nickname');
	if (nickname) {
		document.getElementById('userNickname').innerText = nickname;
	}
	
	// 2. ë¡œê·¸ì¸ ì—¬ë¶€ ì²´í¬
	const token = localStorage.getItem('accessToken');
	if (!token) {
		alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
		window.location.href = "/";
		return;
	}
	// 3. ë¬´í•œ ìŠ¤í¬ë¡¤ ê´€ì°°ì ì„¤ì • (ê°ì‹œ ì‹œì‘)
    const observer = new IntersectionObserver((entries) => {
        // ë°”ë‹¥(sentinel)ì´ ë³´ì´ê³  + ë¡œë”© ì¤‘ì´ ì•„ë‹ˆê³  + ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ì•„ë‹ ë•Œë§Œ ë‹¤ìŒ í˜ì´ì§€ í˜¸ì¶œ
        if (entries[0].isIntersecting && !isLoading && !isLastPage) {
            console.log("ë°”ë‹¥ ê°ì§€! ë‹¤ìŒ í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");
            loadMyMusicList();
        }
    }, { threshold: 0.1 });
	
    const sentinel = document.getElementById('sentinel');
    if (sentinel) observer.observe(sentinel);
    
	console.log("UI ë Œë”ë§ ì™„ë£Œ. ì„œë²„ ì—°ê²°ì€ ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„± í›„ í™œì„±í™” ì˜ˆì •.");
	loadMyMusicList();
	
	document.getElementById('searchInput').addEventListener('keypress', function(e) {
	    if (e.key === 'Enter') {
	        searchMusic();
	    }
	});
	
	
	
});

// 1. ê²€ìƒ‰ì–´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
let currentKeyword = ""; 

async function searchMusic() {
	const searchInput = document.getElementById('searchInput');
    currentKeyword = searchInput.value.trim(); // ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
 	// ì´ˆê¸°í™”: ê²€ìƒ‰ì„ ìƒˆë¡œ ì‹œì‘í•˜ë¯€ë¡œ í˜ì´ì§€ë¥¼ 0ìœ¼ë¡œ, ëª©ë¡ì„ ë¹„ì›€
    currentPage = 0;
    isLastPage = false;
    document.getElementById('music-list-container').innerHTML = ""; 
    
    console.log("ğŸ” ê²€ìƒ‰ ì‹œì‘:", currentKeyword);
    
    // ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    await loadMyMusicList(); 
}



function renderPage() {
	// 
	console.log("Mypage: renderPage skip (static UI)");
}



async function loadMyMusicList() {
    // ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë§ˆì§€ë§‰ í˜ì´ì§€ë©´ ë” ì´ìƒ ìš”ì²­í•˜ì§€ ì•ŠìŒ
    if (isLoading || isLastPage) return;
    
    isLoading = true;
    const spinner = document.getElementById('loading-spinner');
    if (spinner) spinner.classList.remove('d-none');

    try {
        console.log(`ì„œë²„ ìš”ì²­: í˜ì´ì§€ ${currentPage}`);
        // 1. í˜ì´ì§€ ë²ˆí˜¸ì™€ ì‚¬ì´ì¦ˆë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
        //const response = await authFetch(`/api/list?page=${currentPage}&size=20`);
        const response = await authFetch(`/api/list?page=${currentPage}&size=15&keyword=${encodeURIComponent(currentKeyword)}`);
        if (response.ok) {
            const data = await response.json(); // Slice ë˜ëŠ” Page ê°ì²´ ìˆ˜ì‹ 
            
            // 2. ì„œë²„ ì‘ë‹µ ë°ì´í„° êµ¬ì¡°ì— ë”°ë¼ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ (Slice ê°ì²´ë©´ data.content)
            const list = data.content ? data.content : data;
            
            // 3. ë°ì´í„° ê·¸ë¦¬ê¸°
            renderMusicCards(list);
            
            // 4. ë§ˆì§€ë§‰ í˜ì´ì§€ ì—¬ë¶€ ì—…ë°ì´íŠ¸ (ì„œë²„ê°€ ë³´ë‚´ì£¼ëŠ” last í•„ë“œ í™•ì¸)
            isLastPage = data.last; 
            
            // 5. ë‹¤ìŒ ìš”ì²­ì„ ìœ„í•´ í˜ì´ì§€ ë²ˆí˜¸ ì¦ê°€
            if (!isLastPage) {
                currentPage++;
            }
        } else {
            console.error("ì„œë²„ ì‘ë‹µ ì—ëŸ¬:", response.status);
        }
    } catch (err) {
        console.error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", err);
    } finally {
        isLoading = false;
        if (spinner) spinner.classList.add('d-none');
    }
}
        


function renderMusicCards(musicList) {
    const container = document.getElementById('music-list-container');
    
    if (currentPage === 0 && (!musicList || musicList.length === 0)) {
        container.innerHTML = `<div class="col-12 text-center py-5 text-muted">ìŒì•… ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>`;
        return;
    }

    musicList.forEach(music => {
    	// ì‘ì€ë”°ì˜´í‘œ(')ê°€ í¬í•¨ëœ ì œëª©/ê°€ìˆ˜ëª…ì„ ìœ„í•´ escape ì²˜ë¦¬
        const safeTitle = music.title.replace(/'/g, "\\'");
        const safeArtist = (music.artist || "Unknown").replace(/'/g, "\\'");
    	
        const cardHtml = `
        	<div class="col-12">
        		<div class="card history-card p-2">
        			<div class="d-flex align-items-center">
            			<img src="${music.albumCover || '/asset/img/favicon.ico'}" class="album-art me-3">
            			<div class="flex-grow-1 overflow-hidden" style="cursor: pointer;" onclick="musicInfo(${music.musicId})">
            				<h6 class="mb-0 text-truncate" style="font-size: 1rem; font-weight: 500; letter-spacing: -0.3px;">
            					${music.title}
            				</h6>
            				<p class="text-muted mb-0 small text-truncate" style="font-size: 0.85rem; opacity: 0.8;">
            					${music.artist}
            				</p>
            			</div>
            			<div class="d-flex align-items-center ms-2">
            				<button class="btn action-btn text-primary" onclick="playMusic('${music.filePath}')">
            					<i class="bi bi-play-fill" style="font-size: 1.5rem;"></i>
            				</button>
            				<button class="btn action-btn" onclick="downloadMusic('${music.filePath}', '${music.title.replace(/'/g, "\\'")}', '${music.artist.replace(/'/g, "\\'")}')">
            					<i class="bi bi-download" style="font-size: 1.1rem;"></i>
            				</button>
            				<button class="btn action-btn" onclick="deleteMusic(${music.musicId}, this)">
            					<i class="bi bi-x-lg" style="font-size: 1.1rem;"></i>
            				</button>
            			</div>
            		</div>
                </div>
            </div>
		`;
		container.insertAdjacentHTML('beforeend', cardHtml);
	});
}

function musicInfo(musicId) {
    // ìƒì„¸ í˜ì´ì§€ ê²½ë¡œë¡œ ì´ë™ (ì˜ˆ: /music/detail?id=123)
    //window.location.href = `/music/detail?id=${musicId}`;
	// ì¬ìƒì€ ê°€ë²¼ìš´ ì•ˆë‚´ê°€ ì¢‹ìœ¼ë¯€ë¡œ ìš°ì¸¡ ìƒë‹¨ í† ìŠ¤íŠ¸ ì•Œë¦¼ ì‚¬ìš©
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        width: '400px', // í† ìŠ¤íŠ¸ ë„ˆë¹„ë„ ì¡°ì ˆ ê°€ëŠ¥
        timerProgressBar: true
    });

    Toast.fire({
        icon: 'info',
        title: 'ì¬ìƒ ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'
    });
}



</script>
</body>
</html>